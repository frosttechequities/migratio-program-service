<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Robust Ollama Integration Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #333;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    label {
      font-weight: bold;
    }
    textarea, input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
    }
    button {
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .response {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      white-space: pre-wrap;
      display: none;
    }
    .error {
      color: red;
      margin-top: 10px;
    }
    .loading {
      display: none;
      margin-top: 20px;
      text-align: center;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 2s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>Enhanced Ollama Integration Test</h1>

  <div class="container">
    <div class="form-group">
      <label for="question">Question:</label>
      <textarea id="question" rows="4" placeholder="Enter your question here..."></textarea>
    </div>

    <div class="form-group">
      <label for="system-prompt">System Prompt (optional):</label>
      <textarea id="system-prompt" rows="5" placeholder="Enter a system prompt here...">You are an immigration assistant for the Visafy platform. Your role is to provide accurate, factual information about immigration processes, requirements, and documentation.

IMPORTANT GUIDELINES:
1. Only provide factual information about real immigration processes and documents.
2. If you're unsure about specific details, acknowledge the limitations of your knowledge.
3. Structure your responses clearly with headings, bullet points, and numbered lists when appropriate.
4. Focus on being helpful, concise, and accurate rather than comprehensive.
5. Do not make up names of forms or documents that you're not certain exist.
6. When possible, mention official sources where users can find more information.</textarea>
    </div>

    <div class="form-group">
      <label for="timeout">Timeout (ms):</label>
      <input type="number" id="timeout" value="180000" min="10000" step="10000">
    </div>

    <div class="form-group">
      <label>Options:</label>
      <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 5px;">
        <label>
          <input type="checkbox" id="use-vector-search" checked>
          Use Vector Search
        </label>
        <label>
          <input type="checkbox" id="use-fast-model">
          Use Fast Model
        </label>
        <label>
          <input type="checkbox" id="use-pre-computed" checked>
          Use Pre-computed Responses
        </label>
        <label>
          <input type="checkbox" id="use-mock-in-production" checked>
          Use Mock in Production
        </label>
      </div>
    </div>

    <div style="display: flex; gap: 10px;">
      <button id="submit">Submit</button>
      <button id="submit-fast" style="background-color: #2196F3;">Fast Response</button>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Processing your request... This may take a minute or two.</p>
    </div>

    <div id="error" class="error"></div>

    <div id="response" class="response"></div>
  </div>

  <script>
    async function sendRequest(endpoint, useVectorSearch, useFastModel) {
      const question = document.getElementById('question').value.trim();
      const systemPrompt = document.getElementById('system-prompt').value.trim();
      const timeout = parseInt(document.getElementById('timeout').value);
      const loadingEl = document.getElementById('loading');
      const responseEl = document.getElementById('response');
      const errorEl = document.getElementById('error');
      const submitBtn = document.getElementById('submit');
      const submitFastBtn = document.getElementById('submit-fast');

      if (!question) {
        errorEl.textContent = 'Please enter a question';
        return;
      }

      errorEl.textContent = '';
      responseEl.style.display = 'none';
      loadingEl.style.display = 'block';
      submitBtn.disabled = true;
      submitFastBtn.disabled = true;

      const startTime = Date.now();

      try {
        const usePreComputed = document.getElementById('use-pre-computed')?.checked ?? true;
        const useMockInProduction = document.getElementById('use-mock-in-production')?.checked ?? true;

        const response = await fetch(`http://localhost:3009/${endpoint}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            messages: [{ role: 'user', content: question }],
            systemPrompt: systemPrompt || undefined,
            timeout: timeout,
            useVectorSearch: useVectorSearch,
            useFastModel: useFastModel,
            usePreComputed: usePreComputed,
            useMockInProduction: useMockInProduction
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`Server error: ${errorData.message || response.statusText}`);
        }

        const data = await response.json();
        const endTime = Date.now();
        const responseTime = (endTime - startTime) / 1000; // in seconds

        responseEl.innerHTML = `
          <strong>Model:</strong> ${data.model}<br>
          <strong>Method:</strong> ${data.method || 'library/api'}<br>
          <strong>Has Context:</strong> ${data.hasContext}<br>
          <strong>Vector Search Used:</strong> ${data.hasRelevantContext ? 'Yes' : 'No'}<br>
          <strong>Pre-computed:</strong> ${data.isPreComputed ? 'Yes' : 'No'}<br>
          <strong>Response Time:</strong> ${responseTime.toFixed(2)} seconds<br>
          ${data.source ? `<strong>Source:</strong> ${data.source}<br>` : ''}
          <strong>Response:</strong><br><br>
          ${data.response}
        `;
        responseEl.style.display = 'block';
      } catch (error) {
        errorEl.textContent = `Error: ${error.message}`;
      } finally {
        loadingEl.style.display = 'none';
        submitBtn.disabled = false;
        submitFastBtn.disabled = false;
      }
    }

    // Regular submit button
    document.getElementById('submit').addEventListener('click', async () => {
      const useVectorSearch = document.getElementById('use-vector-search').checked;
      const useFastModel = document.getElementById('use-fast-model').checked;
      await sendRequest('chat', useVectorSearch, useFastModel);
    });

    // Fast response button
    document.getElementById('submit-fast').addEventListener('click', async () => {
      await sendRequest('fast-chat', false, true);
    });
  </script>
</body>
</html>
